### ðŸ“– Movie Bets

<ul>
  <li>âœ… <b>Cloud-Native Spring Boot Development Environment and Startup Template</b>
  <li>âœ… <b>Concurrency and Resiliency Patterns in Saga Transactions for Spring Boot Microservices</b>
  <li>âœ… <b>Part 5: Reliable Long-Running Saga Processes</b>
  <li>âœ… <b>Long-running Saga processes, with dynamic recursive conditions for the next step, using Kafka Transactional Consumers and Outbox Pattern</b>
  <li>âœ… <b>Kafka At-least one delivery guarantee and Idempotency Check to prevent duplicate side effects.</b>
</ul>

### ðŸ“– Concurrency and Resiliency Patterns in Saga Transactions for Spring Boot Microservices

#### âœ… Cloud-Native Spring Boot Development and Production Environment with Spring Boot, Kubernetes, Skaffold and Terraform
#### âœ… Reliable Asynchronous Long-Running Saga Processes with Event-Driven Kafka Transactions and Outbox Pattern
#### âœ… At-least once delivery guarantee and Idempotency for Asynchronous Long-Running Saga Processes
#### âœ… Event-Driven Choreography Saga with Spring Kafka Listeners and Kafka Transactions
#### âœ… Outbox Pattern with JPA ACID Transactions
#### âœ… Synchronizing Kafka and Database Transactions with Kafka and JPA Transaction Manager
#### âœ… Handling Concurrency and Parallelization with Kafka Consumer Groups and Partitions
#### âœ… Sequential processing guarantee for messages with the same key
#### âœ… Parallel processing for messages in different partitions
#### âœ… Handling Resiliency with Kafka Consumers and Retryable Exceptions
#### âœ… Retryable Exceptions and Dead-Letter Queue Error Channel with Spring Kafka
#### âœ… E2E Concurrency Testing Framework with Completable Futures using Spring Cloud OpenFeign

### ðŸ“– Cloud-Native Startup Template

<ul style="list-style-type:disc">
  <li>ðŸ“– This <b>Cloud-Native Full-Stack Developer Template</b> provides fully functional Development and Production Environment</li>
    <li>ðŸ“– <b>Next.js</b> and <b>React</b> UI</li>
    <li>ðŸ“– <b>Event-Driven Microservices</b> with Spring Boot, Kafka, PostgreSQL and Outbox Pattern</li>
    <li>ðŸ“– <b>Swagger UI Gateway</b> with Keycloak Authorization</li>
    <li>ðŸ“– <b>Kafka UI</b></li>
    <li>ðŸ“– <b>Kafka Cluster</b> with Strimzi Operator</li>
    <li>ðŸ“– <b>E2E Testing Service</b> with Spring Cloud OpenFeign REST Client</li>
    <li>ðŸ“– Local <b>Kubernetes</b> Development Environment with <b>Skaffold</b></li>
    <li>ðŸ“– Production <b>Kubernetes</b> Development Environment with <b>Skaffold</b></li>
    <li>ðŸ“– <b>Github Actions</b> CI/CD <b>GitOps</b> pipeline</li>
    <li>ðŸ“– <b>Azure Terraform</b> Infrastructure with <b>AKS Kubernetes Cluster</b> and <b>Private Container Registry</b></li>
  <li>ðŸ“– Full <b>Technology Stack</b>:</li>
  <ul>
    <li>âœ… <b>React UI</b></li>  
    <li>âœ… <b>Next.js React Framework</b> with Keycloak Authorization</li>
    <li>âœ… <b>Event-Driven Microservices with Spring Boot and Kafka</b></li>
    <li>âœ… <b>Spring Kafka Event Listeners</b></li>
    <li>âœ… <b>Synchronized Kafka and JPA Transactions for Outbox Pattern</b></li>
    <li>âœ… <b>Safe Idempotent Retry Transactions with Idempotency Key and At-Least Once Delivery Guarantee</b></li>
    <li>âœ… <b>Lookup Tables for Safe Idempotent Retries using Idempotency Key and PostgreSQL Database</b></li>
    <li>âœ… <b>PostgreSQL Database</b></li>
    <li>âœ… <b>Keycloak OAuth2 Authorization Server</b></li>
    <li>âœ… <b>Spring Cloud Gateway</b> with Keycloak Authorization</li>
    <li>âœ… <b>Spring Cloud OpenFeign</b></li>
    <li>âœ… <b>Swagger UI</b> with Keycloak Authorization</li>
    <li>âœ… <b>Kafka UI</b></li>
    <li>âœ… <b>Terraform</b></li>
    <li>âœ… <b>Kubernetes</b></li>
    <li>âœ… <b>Github Actions</b></li>
    <li>âœ… <b>Github Secrets and envsubst Environment Variables parser</b></li>
    <li>âœ… <b>Kubernetes Secrets and Configmap Variables</b></li>
    <li>âœ… <b>Local Kubernetes Development Environment with Skaffold</b></li>
    <li>âœ… <b>Production Kubernetes Development Environment with Skaffold</b></li>
    <li>âœ… <b>Custom Kubernetes Manfiests Generation for Local and Production Environments with sh scripts</b></li>
    <li>âœ… <b>Custom Skaffold Manifests Generation for Local and Production Environments with sh scripts</b></li>
    <li>âœ… <b>Hot reload of Next.js React Javascript code for Local and Production Environments with Skaffold</b></li>
    <li>âœ… <b>Hot reload of Spring Boot Java code for Local and Production Environments with Skaffold</b></li>
    <li>âœ… <b>Hot reload of Docker Containers for Local and Production Environments with Skaffold</b></li>
  </ul>
</ul>


### ðŸ“– Links

- [Concurrency and Resiliency Patterns in Saga Transactions for Spring Boot Microservices, Parts 1-4](https://www.linkedin.com/posts/michaelsklyar_concurrency-and-resiliency-patterns-in-activity-7168742915765059586-irvJ)
- [Apache Kafka for Event-Driven Spring Boot Microservices Udemy Course](https://www.udemy.com/course/apache-kafka-for-spring-boot-microservices)
- [Demo Saga Pattern, Outbox Pattern using Spring Boot, Debezium, Kafka, Kafka Connect](https://github.com/uuhnaut69/saga-pattern-microservices)
- [Stock Tracking Platform with Outbox Pattern, Kafka Event Streaming, Debezium CDC Connector and PostgreSQL](https://github.com/skyglass/stock-tracking-03)
- [Video Streaming Platform with Debezium CDC Kafka Connector, Kafka Event Streaming, Minio File Storage and FFmpeg Video Processing](https://github.com/greeta-video-01/video-api)
- [E2E Testing Pipeline for Spring Boot Microservices using OpenFeign Client and Github Actions](https://www.linkedin.com/pulse/e2e-testing-pipeline-spring-boot-microservices-using-openfeign/)
- [Microservices with Node JS and React Udemy Course](https://www.udemy.com/course/microservices-with-node-js-and-react)


## ðŸ“– Step By Step Guide

### Step 01 - Create New Github Repository

- Clone this repository and copy the source code to your new repository

### Step-02: Prepare Your Azure Account

- make sure you have your own Azure Account with enough permissions (Sign Up for a Free Trial, if you don't have one)

### Step-03: Prepare Your Github Account

- make sure you have your own Github Account

### Step-04: Prepare Source Code and Github Actions Workflow:

- Edit "**.github/workflows/deploy-*.yaml**" files: replace "**master**" with the name of your main branch (you can change default main branch name in github repository settings)

- Edit "**k8s/prod/ingress-srv.yaml**" file: replace "**skycomposer.net**" with the name of your registered domain (see **Step-05** and **Azure Production Environment Setup** for more details)


### Step-05: Register your domain:

- You need a registered domain to provide TLS connection with trusted Certificate Authority.

- For more details on setting up TLS on AKS Ingress with LetsEncrypt see this article: https://medium.com/@jainchirag8001/tls-on-aks-ingress-with-letsencrypt-f42d65725a3
  This article will show you how to configure TLS on AKS with LetsEncrypt for any registered domain, including AWS Route 53.

- Make sure that you know how to create Hosted Zone and Record A for your domain provider.

- For more details, see `Azure Production Environment Setup`

### Step-06: Finish Udemy Course "Apache Kafka for Event-Driven Spring Boot Microservices":

- If you need help on Microservices with Spring Boot and Kafka, see more details in this course: https://www.udemy.com/course/apache-kafka-for-spring-boot-microservices
- I strongly recommend you finish this course first, before following this guide!
- This guide will only help you deploy the microservices to azure cloud kubernetes cluster, enable github actions cd pipeline and configure local and production kubernetes development environment with skaffold
- All information about Kafka Concurrency, Parallelization, Transactions, Durability, Error Handling, Integration Testing, Scalability, Spring + Kafka, Event-Driven Microservices with Kafka, Data Replication and Concurrency Control for Microservices, Saga Transactions, and so on, is perfectly explained in this course!
- The example in this source code also shows code for starting long-running "Bet Settlement" saga process, with no statically predefined condition to end. Choreography Saga with synchronized Kafka and JPA Transactions and at-least once processing guarantee, allows dynamically starting many small micro-events and then wait until all jobs are done to continue or to finish.


## Local Kubernetes Environment Setup with Skaffold:

- Create local Kubernetes Cluster. If you have Docker Desktop, just go to Settings -> Kubernetes -> Enable Kubernetes ->  Apply & Restart

- Switch context to local Kubernetes Cluster. If you have Docker Desktop, just go to Kubernetes Context and select "docker-desktop"

```
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/cloud/deploy.yaml
```
- These commands will install nginx ingress controller to your local kubernetes cluster. You need nginx ingress controller for your local kubernetes ingress resource to work correctly (see `k8s/local/ingress-srv.yaml` for more information on your local kubernetes ingress resource)
- These commands are already included in the `scripts/local/prepare-k8s.sh`, so you don't need to run them, if you run `sh-skaffold-dev.sh` script

- create `env` folder in the root of the project

- create `.env.local` file in `env` folder and provide the following parameters:

```
CONTAINER_REGISTRY="moviebets.azurecr.io"
DOCKER_FILE_NAME="Dockerfile"
DOCKER_PUSH="false"
VERSION="latest"
BASE_URL="http://ingress-nginx-controller.ingress-nginx.svc.cluster.local"
API_BASE_URL="http://ingress-nginx-controller.ingress-nginx.svc.cluster.local/api"
KEYCLOAK_BASE_URL="http://localhost/keycloak"
```

- Don't Worry! `env` folder is included to .gitignore. You will not reveal your secrets with git commit! :)
- Note: CONTAINER_REGISTRY for local development environment can be any prefix, but it is recommended to use container registry name for consistency with production environment
- BASE_URL for local kubernetes cluster uses ingress-nginx service ip. Please, don't change it! If your nginx-ingress controller is installed correctly, this url will work as expected.

```
mvn clean install -DskipTests
```
This command will prepare java libraries for deployment


```
sh skaffold-local.sh
```
This script will build docker images and start local kubernetes environment with hot reloading of your code changes


- open `localhost` in your Browser and make sure that `Sign Up` and `Sign In` works, you are able to `Create Movie Event` and place bet on it.

- optionally, create 2 test accounts by registering on the `Keycloak Login` Page, create movie event and place bet with one account and do the same with another account.

- If the winner exists at the move event close time, then the movie event is closed, and the bets start to settle by recursively triggering kafka events during settlement, until all settlement jobs are finished.
- Note: If the winner doesn't exist, then the movie event is configured to be closed later, after configurable amount of time (6ÃŸ seconds by default)
- The winner exists only if the movie has more votes than another movie. If the votes are equal, the movie event is extended for configurable duration, until there is a winner.

- Congratulations! You successfuly tested `Movie Bets App` locally!


## Azure Production Kubernetes Environment Setup with Skaffold:

- create `terraform.auto.tfvars` file in `infra` folder and provide following parameters:

```
kubernetes_version= "1.32.2"
app_name = "{provide_your_own_globally_unique_name}"
location = "westeurope" (use any other azure location, for example, "germanywestcentral", if you have any issues with "westeurope")
```

- login to Azure Cloud with `az login` CLI

- cd to `infra` folder

- replace `moviebets` with your own globally unique name (see files `container-registry.tf`, `kubernetes-cluster.tf` and `resource-group.tf`)

- run `terraform init`and `terraform apply --auto-approve`

- after the script is successfully finished, run the following command:

```
az aks get-credentials --resource-group {your_app_name} --name {your_app_name}
```

- Make sure that your context is switched from local Kubernetes Cluster to Azure Kubernetes Cluster. If you have Docker Desktop, just open Kubernetes Context and make sure that the name of the context corresponds to your Azure Kubernetes Cluster

- run `kubectl get pods` and make sure that `kubectl` works correctly and returns 0 resources

- login to Azure Container registry with the following command:

```
docker login {login_server}
```

- you can find docker login server, username and password in Azure Cloud (go to Container Registry -> Settings -> Access Keys)

- in `env` folder create `.env.prod` file and set the following environment variables:

```
CONTAINER_REGISTRY="moviebets.azurecr.io"  (provide your own globally unique container registry)
DOCKER_FILE_NAME="Dockerfile"
DOCKER_PUSH="true"
VERSION="latest"
BASE_URL="https://skycomposer.net" (provide your own domain name, see `Step-05` and notes below for more details)
API_BASE_URL="https://skycomposer.net/api"
KEYCLOAK_BASE_URL="https://skycomposer.net/keycloak"
```

- Don't Panic! `env` folder is included to .gitignore. You will not reveal your secrets with git commit! :)
- Make sure you set your own values for CONTAINER_REGISTRY, BASE_URL, API_BASE_URL and KEYCLOAK_BASE_URL (replace `skycomposer.net` with the name of your domain)

- Register your domain and enable TLS on AKS Ingress with Lestencrypt: https://medium.com/@jainchirag8001/tls-on-aks-ingress-with-letsencrypt-f42d65725a3
- Make sure you provide your email for CA cluster issuer in `k8s/cert/cluser-issuer.yml` Kubernetes resource (see more details in the article)
- Make sure you installed ingress controller with helm (see more details in the article)
- Make sure you installed all other kubernetes resources and followed other instructions in the article
- You can find production Ingress Kubernetes Resource in `k8s/prod/ingress-srv.yaml`. This resource will be applied with `sh skaffold-prod.sh` script. Make sure that you replaced `skycomposer.net` with your registered domain name
- If you run `sh skaffold-prod.sh`, then you also install ingress controller and letsencrypt kubernetes resources, described in the article, see the details in `scripts/prod/prepare-k8s.sh` file

- run `sh skaffold-prod.sh`

- This script will build docker images, push them to azure container registry and deploy images to production kubernetes cluster with hot reloading of your code changes

- Run `kubectl get pods` and make sure that all containers are RUNNING

- Edit ingress `cm-acme-http-solver`, as described in the article: https://medium.com/@jainchirag8001/tls-on-aks-ingress-with-letsencrypt-f42d65725a3
- Verify that certificate `tls-secret` is working (Ready = True, see the article for more details)

- Open https url with your registered domain in your Browser and make sure that Keycloak `Login` and `Register` works, you are able to `Create a Movie Event` and place a bet on it
- You can use `admin`, password `admin` for user with admin privileges and `user`, password `user` for regular user
- Any new user, registered with Keycloak is automatically assigned regular user privileges

- Optionally, register 2 new users, create movie event with one account and place bet with another account
- Congratulations! You successfully tested `Moive Bets App` in production!

- The only difference between `skaffold dev` and `skaffold prod` is that `skaffold dev` allows hot reloading of your code changes on production! Try to make any code change with your IDE and you will immediately see this change on production!

- If you run `sh skaffold-local.sh` or `sh skaffold-prod.sh` you will see logs in real-time. After closing the cli window, all kubernetes resources will be destroyed! Therefore, in order to deploy final changes to production, replace `skaffold dev` with `skaffold run` in the `skaffold-prod.sh` script. You will not have hot reloading with `skaffold run` anymore, but kubernetes resources will not be destroyed after you close cli window.

## Github Actions Deployment Pipeline Setup

- create the following Github Secrets (Go to Your Repository -> Settings -> Secrets and Variables -> Actions -> New Repository Secret):

```
CONTAINER_REGISTRY=... (Azure Container Registry)
KUBE_CONFIG=.. (Base64 encoded  ~/.kube/config file contents)
REGISTRY_UN=... (Azure Container Registry Username)
REGISTRY_PW=... (Azure Container Registry Password)
```

- you can find values for CONTAINER_REGISTRY, REGISTRY_UN and REGISTRY_PW in Azure Cloud (go to Container Registry -> Settings -> Access Keys)
- you can get the value of KUBE_CONFIG with this command `cat ~/.kube/config | base64` (make sure you switched context to Azure Production Kubernetes Cluster before running this command!)

- make any code changes (for example change `SkyComposer` to `SkyComposer 2` in `moviebets-ui/components/header.js` file)

- push changes with `git add .`, `git commit -m "test changes"`and `git push origin`

- go to "Your repository -> Actions" and make sure that the Deployment Pipeline is automatically started and successfully finished

- this pipeline will build changed docker image, push it to container registry and deploy changed image with new version to kubernetes cluster

- open https link for your registered domain in your Browser and make sure that you can see `SkyComposer 2` title on the top left

- Congratulations! You successfuly tested `Movie Bets App` code changes with Github Actions Deployment Pipeline!